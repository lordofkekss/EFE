{% extends 'base.html' %}
{% block title %}Kurs{% endblock %}
{% block content %}
<h4 class="mb-3">Kurs</h4>
<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-sections" type="button" role="tab">Abschnitte</button></li>
  <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-exercises" type="button" role="tab">Übungen</button></li>
  <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-files" type="button" role="tab">Dateien</button></li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="tab-sections" role="tabpanel">
    {% if current_user.role in ['teacher','admin'] %}
      <div class="alert alert-secondary">Tipp: Reihenfolge via Drag & Drop ändern.</div>
    {% endif %}
    <ul class="list-group" id="section-list">
      {% for n in sections %}
        <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ n.id }}">
          <div>
            <strong>{{ n.title }}</strong>
            {% if n.released_at %}
              <span class="badge bg-success ms-2">freigegeben</span>
            {% else %}
              <span class="badge bg-secondary ms-2">gesperrt</span>
            {% endif %}
          </div>
          <div class="btn-group">
            {% if current_user.role in ['teacher','admin'] %}
              <a class="btn btn-sm btn-outline-primary" href="/courses/{{ course.id }}/section/{{ n.id }}/edit">Bearbeiten</a>
              <a class="btn btn-sm btn-outline-secondary" href="/courses/{{ course.id }}/section/{{ n.id }}/pdf">PDF</a>
              <form method="post" action="/courses/{{ course.id }}/content/{{ n.id }}/release" class="d-inline ms-1">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if n.released_at %}
                  <input type="hidden" name="action" value="unrelease">
                  <button class="btn btn-sm btn-warning">Sperren</button>
                {% else %}
                  <input type="hidden" name="action" value="release">
                  <button class="btn btn-sm btn-success">Freigeben</button>
                {% endif %}
              </form>
            {% endif %}
          </div>
        </li>
      {% else %}
        <li class="list-group-item">Noch keine Abschnitte.</li>
      {% endfor %}
    </ul>
  </div>

  <div class="tab-pane fade" id="tab-exercises" role="tabpanel">
    <ul class="list-group">
      {% for n in exercises %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span>{{ n.title }}</span>
          <div>
            {% if current_user.role in ['teacher','admin'] %}
              <form method="post" action="/courses/{{ course.id }}/content/{{ n.id }}/release" class="d-inline me-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if n.released_at %}
                  <input type="hidden" name="action" value="unrelease">
                  <button class="btn btn-sm btn-warning">Sperren</button>
                {% else %}
                  <input type="hidden" name="action" value="release">
                  <button class="btn btn-sm btn-success">Freigeben</button>
                {% endif %}
              </form>
            {% endif %}
            <a class="btn btn-sm btn-outline-primary" href="/courses/{{ course.id }}/exercise/{{ n.id }}">Öffnen</a>
          </div>
        </li>
      {% else %}
        <li class="list-group-item">Noch keine Übungen.</li>
      {% endfor %}
    </ul>
  </div>

  <div class="tab-pane fade" id="tab-files" role="tabpanel">
    {% if current_user.role in ['teacher','admin'] %}
      <form class="mb-3" method="post" action="/courses/{{ course.id }}/upload" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="input-group">
          <input type="file" name="file" class="form-control" required>
          <button class="btn btn-outline-primary">Hochladen</button>
        </div>
      </form>
    {% endif %}
    <ul class="list-group">
      {% for d in docs %}
        <li class="list-group-item"><a href="/courses/files/{{ d.path }}" target="_blank">{{ d.filename }}</a> <span class="text-muted small">({{ d.mime_type }})</span></li>
      {% else %}
        <li class="list-group-item">Noch keine Dateien.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<div class="mt-4">
  <a class="btn btn-outline-primary" href="/courses/{{ course.id }}/live">Live-Modus starten</a>
</div>

{% if current_user.role in ['teacher','admin'] %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
new Sortable(document.getElementById('section-list'), {
  animation: 150,
  onEnd: function() {
    const order = [...document.querySelectorAll('#section-list [data-id]')].map((li, idx) => ({id: li.dataset.id, index: idx}));
    fetch('/courses/{{ course.id }}/reorder', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({order})
    });
  }
});
</script>
{% endif %}
{% endblock %}
