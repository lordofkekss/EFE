<!-- app/templates/courses/detail.html -->
{% extends 'base.html' %}
{% block title %}Kurs – Details{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">
    Kurs
    {% if course and course.school_year %}<small class="text-muted">({{ course.school_year }})</small>{% endif %}
  </h4>

  <div class="d-flex align-items-center gap-2">
    {% if current_user.role in ['teacher','admin'] %}
      <a class="btn btn-sm btn-outline-primary" href="/courses/{{ course.id }}/live">Live starten/öffnen</a>
    {% endif %}
    {% if current_user.role == 'student' %}
      <a id="btn-join" class="btn btn-sm btn-success d-none" href="/courses/{{ course.id }}/live/join">Live-Session beitreten</a>
      <span id="live-off" class="badge bg-secondary">keine Live-Session</span>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-body">
        <h5 class="mb-3">Inhalte</h5>

        {% if items and items|length > 0 %}
          <ul class="list-group">
            {% for it in items %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="me-2">
                  {% if it.kind == 'section' %}
                    <span class="badge bg-primary me-2">Abschnitt</span>
                    <strong>{{ it.title }}</strong>
                  {% elif it.kind == 'exercise' %}
                    <span class="badge bg-info text-dark me-2">Übung</span>
                    <strong>{{ it.title }}</strong>
                  {% elif it.kind == 'file' %}
                    <span class="badge bg-secondary me-2">Datei</span>
                    <strong>{{ it.title }}</strong>
                  {% else %}
                    <span class="badge bg-light text-dark me-2">{{ it.kind|default('Inhalt') }}</span>
                    <strong>{{ it.title }}</strong>
                  {% endif %}
                </div>

                <div class="d-flex align-items-center gap-2">
                  {% if it.kind == 'section' %}
                    <a class="btn btn-sm btn-outline-primary" href="/courses/{{ course.id }}/section/{{ it.id }}/view">Öffnen</a>
                    {% if current_user.role in ['teacher','admin'] %}
                      <a class="btn btn-sm btn-outline-secondary" href="/courses/{{ course.id }}/section/{{ it.id }}/edit">Bearbeiten</a>
                      <a class="btn btn-sm btn-outline-success" href="/courses/{{ course.id }}/section/{{ it.id }}/pdf">Als PDF</a>
                      <form method="post" action="/courses/{{ course.id }}/content/{{ it.id }}/release" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        {% if it.released %}
                          <input type="hidden" name="action" value="unrelease">
                          <button class="btn btn-sm btn-warning">Sperren</button>
                        {% else %}
                          <input type="hidden" name="action" value="release">
                          <button class="btn btn-sm btn-success">Freigeben</button>
                        {% endif %}
                      </form>
                    {% endif %}
                    {% elif it.kind == 'exercise' %}
                      <span class="badge {{ 'bg-success' if it.id in completed_ids else 'bg-light text-dark' }} me-2">
                        {{ exercise_counts.get(it.id, 0) }}/{{ total_students }}
                      </span>
                      <a class="btn btn-sm btn-outline-primary" href="/courses/{{ course.id }}/exercise/{{ it.id }}">Öffnen</a>
                      {% if current_user.role in ['teacher','admin'] %}
                        <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal"
                                data-bs-target="#statsModal" data-node="{{ it.id }}">Ergebnisse</button>
                        <a class="btn btn-sm btn-outline-secondary" href="/courses/{{ course.id }}/exercise/{{ it.id }}/edit">Bearbeiten</a>
                        <form method="post" action="/courses/{{ course.id }}/content/{{ it.id }}/release" class="d-inline">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          {% if it.released %}
                            <input type="hidden" name="action" value="unrelease">
                            <button class="btn btn-sm btn-warning">Sperren</button>
                          {% else %}
                            <input type="hidden" name="action" value="release">
                            <button class="btn btn-sm btn-success">Freigeben</button>
                          {% endif %}
                        </form>
                      {% endif %}
                  {% elif it.kind == 'file' %}
                    {% set path = doc_paths.get(it.id) %}
                    {% if path %}
                      <a class="btn btn-sm btn-outline-primary" href="/courses/files/{{ path }}" target="_blank">Download</a>
                    {% endif %}
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Noch keine Inhalte.</div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if current_user.role in ['teacher','admin'] %}
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <h5 class="mb-3">Neuen Inhalt anlegen</h5>
        <form method="post" action="/courses/{{ course.id }}/content/create">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-2">
            <label class="form-label">Typ</label>
            <select name="type" class="form-select">
              <option value="section">Abschnitt</option>
              <option value="exercise">Übung</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Titel</label>
            <input name="title" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Reihenfolge (Zahl, optional)</label>
            <input name="order_index" class="form-control" placeholder="z. B. 10">
          </div>

          <div id="section-fields" class="mb-2">
            <label class="form-label">Inhalt (Markdown/HTML, optional)</label>
            <textarea name="body_md" class="form-control" rows="4"></textarea>
          </div>

          <div id="exercise-fields" class="mb-2 d-none">
            <label class="form-label">Aufgabenstellung (Markdown/kurz)</label>
            <textarea name="prompt_md" class="form-control" rows="4"></textarea>
            <label class="form-label mt-2">Art</label>
            <select name="kind" class="form-select">
              <option value="short_answer">Kurzantwort</option>
              <option value="mc">Multiple Choice</option>
              <option value="rich">Rich (Editor)</option>
            </select>
          </div>

          <button class="btn btn-primary mt-2">Anlegen</button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
  {% if current_user.role in ['teacher','admin'] %}
<div class="card mt-3">
  <div class="card-body">
    <h5 class="mb-3">Downloads & Exporte</h5>
    {% if export_docs and export_docs|length > 0 %}
      <ul class="list-group">
        {% for d in export_docs %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="bi bi-file-earmark-pdf me-2"></i>{{ d.title or 'Export' }}</span>
            <a class="btn btn-sm btn-outline-primary" href="/courses/files/{{ doc_paths[d.id] }}" target="_blank">Öffnen</a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Noch keine Exporte.</div>
    {% endif %}
  </div>
</div>
{% endif %}

</div>
<!-- Stats-Modal -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statsLabel">Übungsergebnisse</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>
      <div class="modal-body">
        <div id="statsBody" class="table-responsive small">
          <div class="text-muted">Lade …</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('statsModal');
  modal?.addEventListener('show.bs.modal', async (ev)=>{
    const btn = ev.relatedTarget;
    const nodeId = btn?.getAttribute('data-node');
    if(!nodeId) return;
    const box = document.getElementById('statsBody');
    box.innerHTML = '<div class="text-muted">Lade …</div>';
    try{
      const r = await fetch(`/courses/{{ course.id }}/exercise/${nodeId}/stats`, {cache:'no-store'});
      const j = await r.json();
      let rows = (j.rows || []).map(r => `
        <tr>
          <td>${r.username}</td>
          <td>${r.status}</td>
          <td class="text-end">${r.score ?? '-'}</td>
          <td class="text-end">${r.total_points ?? '-'}</td>
          <td class="text-end">${r.percent ?? '-' }%</td>
          <td>${r.passed === null ? '-' : (r.passed ? '<span class="badge bg-success">bestanden</span>' : '<span class="badge bg-danger">nicht</span>')}</td>
          <td class="text-end">${r.attempts ?? 1}</td>
        </tr>`).join('');
      if(!rows) rows = '<tr><td colspan="7" class="text-muted">Keine Abgaben.</td></tr>';
      box.innerHTML = `
        <table class="table table-sm">
          <thead><tr>
            <th>Schüler</th><th>Status</th><th class="text-end">Punkte</th>
            <th class="text-end">Max</th><th class="text-end">%</th><th>Live</th><th class="text-end">Versuche</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="small text-muted">Abgeschlossen: ${j.completed}/${j.total_students}</div>
      `;
    }catch(e){
      box.innerHTML = '<div class="text-danger">Fehler beim Laden.</div>';
    }
  });
})();
</script>


{% if current_user.role == 'student' %}
<script>
(function(){
  async function poll(){
    try{
      const r = await fetch('/courses/{{ course.id }}/live/status', {cache:'no-store'});
      const j = await r.json();
      const btn = document.getElementById('btn-join');
      const off = document.getElementById('live-off');
      if(j.active){
        btn.classList.remove('d-none');
        off.classList.add('d-none');
      }else{
        btn.classList.add('d-none');
        off.classList.remove('d-none');
      }
    }catch(e){}
  }
  poll();
  setInterval(poll, 5000);
})();
</script>
{% endif %}

<script>
(function(){
  // kleines UI-Flip zwischen Abschnitt/Übung Formularfeldern
  const sel = document.querySelector('select[name="type"]');
  if(!sel) return;
  const sec = document.getElementById('section-fields');
  const ex  = document.getElementById('exercise-fields');
  sel.addEventListener('change', ()=>{
    const v = sel.value;
    if(v === 'exercise'){ ex.classList.remove('d-none'); sec.classList.add('d-none'); }
    else { sec.classList.remove('d-none'); ex.classList.add('d-none'); }
  });
})();
</script>
{% endblock %}
