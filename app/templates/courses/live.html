{% extends 'base.html' %}
{% block title %}Live-Modus (Lehrer){% endblock %}
{% block content %}
<script src="/socket.io/socket.io.js"></script>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Live-Modus</h4>
  <div class="text-end">
    <div class="small text-muted">Beitritts-Code (nur Lehrkraft):</div>
    <div class="fs-4"><strong>{{ session.join_code }}</strong></div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="list-group" id="slides-list" style="max-height:70vh;overflow:auto;">
      {% for s in slides %}
        <a href="#" class="list-group-item list-group-item-action slide-link" data-idx="{{ loop.index0 }}">
          <span class="badge bg-primary">Slide {{ loop.index }}</span>
        </a>
      {% else %}
        <div class="text-muted small">Keine Inhalte.</div>
      {% endfor %}
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <button id="prev" class="btn btn-outline-secondary btn-sm">‹</button>
          <button id="next" class="btn btn-outline-secondary btn-sm">›</button>
        </div>
        <div class="d-flex align-items-center gap-2">
          <input type="color" id="color" value="#000000" class="form-control form-control-color">
          <select id="width" class="form-select form-select-sm" style="width:auto;">
            <option>2</option><option>4</option><option>6</option><option>8</option><option>12</option>
          </select>
          <button id="clear" class="btn btn-warning btn-sm">Seite löschen</button>
          <button id="end" class="btn btn-danger btn-sm">Beenden & PDF</button>
        </div>
      </div>

      <div id="slide-content" class="mb-2" style="min-height:120px;">
        {% if slides|length %}{{ slides[0].html | safe }}{% endif %}
      </div>
      <canvas id="wb" width="1200" height="800" class="border w-100" style="aspect-ratio:3/2;"></canvas>
    </div></div>
  </div>
</div>

<script>
(function(){
  const sessionId = "{{ session.id }}";
  const socket = io({ withCredentials: true });

  socket.emit('join_live', {session_id: sessionId, role: 'teacher'});

  const slides = {{ slides|tojson }};
  let idx = 0;

  const slideEl = document.getElementById('slide-content');
  const list = document.getElementById('slides-list');

  list.querySelectorAll('.slide-link').forEach(a => {
    a.addEventListener('click', (e) => { e.preventDefault(); idx = parseInt(a.dataset.idx||'0'); renderSlide(true); });
  });
  document.getElementById('prev').onclick = () => { if (idx>0){ idx--; renderSlide(true);} };
  document.getElementById('next').onclick = () => { if (idx<slides.length-1){ idx++; renderSlide(true);} };

  const cvs = document.getElementById('wb');
  const ctx = cvs.getContext('2d');
  const color = document.getElementById('color');
  const width = document.getElementById('width');
  const buf = new Map();

  let drawing=false, last=null;
  cvs.addEventListener('pointerdown', e => { drawing=true; last=[e.offsetX,e.offsetY]; });
  cvs.addEventListener('pointerup', ()=>{ drawing=false; last=null; saveBuf(); });
  cvs.addEventListener('pointerleave', ()=>{ drawing=false; last=null; saveBuf(); });
  cvs.addEventListener('pointermove', e => {
    if (!drawing || !last) return;
    draw(last[0], last[1], e.offsetX, e.offsetY, parseInt(width.value), color.value, true);
    last=[e.offsetX,e.offsetY];
  });

  function draw(x0,y0,x1,y1,w,c,bcast){
    ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1);
    ctx.lineWidth=w; ctx.lineCap='round'; ctx.strokeStyle=c||'#000';
    ctx.stroke();
    if (bcast) socket.emit('draw', {session_id: sessionId, slide: idx, x0,y0,x1,y1,w,c});
  }
  function clearSlide(bcast){
    ctx.clearRect(0,0,cvs.width,cvs.height);
    if (bcast) socket.emit('clear', {session_id: sessionId, slide: idx});
    saveBuf();
  }
  function saveBuf(){ buf.set(idx, cvs.toDataURL('image/png')); }
  function restoreBuf(){
    const imgData = buf.get(idx);
    ctx.clearRect(0,0,cvs.width,cvs.height);
    if (!imgData) return;
    const img = new Image();
    img.onload = ()=> ctx.drawImage(img,0,0,cvs.width,cvs.height);
    img.src = imgData;
  }

  document.getElementById('clear').onclick = ()=> clearSlide(true);

  document.getElementById('end').onclick = async ()=>{
    socket.emit('end_session', {session_id: sessionId});
    const pages = [];
    for (let i=0;i<slides.length;i++){
      const img = buf.get(i);
      if (img) pages.push(img);
    }
    if (pages.length){
      const r = await fetch(window.location.pathname.replace('/live','/live/export'), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({images: pages})
      });
      const j = await r.json();
      if (j.ok && j.pdf_url) window.location = j.pdf_url;
    }
    window.location = window.location.pathname.replace('/live','');
  };

  function renderSlide(bcast){
    slideEl.innerHTML = slides[idx]?.html || '';
    restoreBuf();
    if (bcast){
      socket.emit('slide_change', {session_id: sessionId, index: idx, html: slideEl.innerHTML});
    }
  }

  socket.on('clear', data => { if (data.slide===idx) restoreBuf(); });

  renderSlide(true);
})();
</script>
{% endblock %}
