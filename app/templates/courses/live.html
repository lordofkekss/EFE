{% extends 'base.html' %}
{% block title %}Live-Modus{% endblock %}
{% block content %}
<h4 class="mb-3">Live-Modus</h4>
<div class="row g-3">
  <div class="col-lg-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Abschnitte</h6>
        <ol id="section-list" class="list-group list-group-numbered">
          {% for s in sections %}
            <li class="list-group-item d-flex justify-content-between align-items-center" data-index="{{ loop.index0 }}">
              <span>{{ s.title }}</span>
              {% if current_user.role in ['teacher','admin'] %}
                <button class="btn btn-sm btn-outline-primary" onclick="goTo({{ loop.index0 }})">Zeigen</button>
              {% endif %}
            </li>
          {% endfor %}
        </ol>
        {% if current_user.role in ['teacher','admin'] %}
          <div class="d-grid gap-2 mt-2">
            <button class="btn btn-outline-secondary" onclick="prev()">← Zurück</button>
            <button class="btn btn-outline-secondary" onclick="next()">Weiter →</button>
            <button class="btn btn-success" onclick="exportPDF()">Beenden & PDF</button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-9">
    <div class="position-relative border" style="height:70vh;">
      <iframe id="slide" class="w-100 h-100" style="background:white;"></iframe>
      <canvas id="wb" class="position-absolute top-0 start-0" style="width:100%; height:100%; pointer-events: {{ 'auto' if current_user.role in ['teacher','admin'] else 'none' }};"></canvas>
      {% if current_user.role in ['teacher','admin'] %}
      <div class="position-absolute top-0 end-0 m-2 p-2 bg-light border rounded d-flex gap-2 align-items-center">
        <select id="penColor" class="form-select form-select-sm" style="width:auto;">
          <option value="#000000">Schwarz</option>
          <option value="#ff0000">Rot</option>
          <option value="#0000ff">Blau</option>
          <option value="#00aa00">Grün</option>
          <option value="#ffaa00">Orange</option>
        </select>
        <select id="penWidth" class="form-select form-select-sm" style="width:auto;">
          <option>2</option><option>4</option><option>6</option><option>8</option><option>12</option>
        </select>
        <button class="btn btn-sm btn-outline-danger" onclick="clearInk()">Löschen</button>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const socket = io();
const room = `course:{{ course.id }}`;
socket.emit('join_session', { session_id: room });

const sections = [{% for s in sections %}{id:'{{ s.id }}', html:`{% filter forceescape %}{{ s.body_html or '' }}{% endfilter %}`}{% if not loop.last %},{% endif %}{% endfor %}];
let idx = 0;

const iframe = document.getElementById('slide');
const canvas = document.getElementById('wb');
let ctx, drawing=false, last=null;

function resizeCanvas(){
  const rect = iframe.getBoundingClientRect();
  canvas.width = rect.width; canvas.height = rect.height;
  ctx = canvas.getContext('2d');
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function render(i){
  idx = Math.max(0, Math.min(i, sections.length-1));
  const doc = `<!doctype html><html><head><meta charset='utf-8'><style>body{font-family:Arial;padding:24px;} img,video{max-width:100%;}</style></head><body>${sections[idx].html}</body></html>`;
  const blob = new Blob([doc], {type: 'text/html'});
  iframe.src = URL.createObjectURL(blob);
}
render(0);

function goTo(i){ render(i); socket.emit('slide_to', {room, index: i}); }
function next(){ goTo(idx+1); }
function prev(){ goTo(idx-1); }

socket.on('slide_changed', (data)=>{ if(typeof data.index==='number'){ render(data.index); }});

// Whiteboard
function getPen(){ return {color: document.getElementById('penColor').value, width: parseInt(document.getElementById('penWidth').value,10)}; }
function pos(e){ const r=canvas.getBoundingClientRect(); return {x:(e.clientX-r.left), y:(e.clientY-r.top)}; }
function line(a,b,style){ ctx.strokeStyle = style.color; ctx.lineWidth = style.width; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }
function emitDraw(a,b,style){ socket.emit('draw', {room, x0:a.x, y0:a.y, x1:b.x, y1:b.y, color:style.color, width:style.width, slide: idx}); }

if ({{ 'true' if current_user.role in ['teacher','admin'] else 'false' }}){
  canvas.addEventListener('mousedown', e=>{ drawing=true; last=pos(e); });
  canvas.addEventListener('mousemove', e=>{ if(!drawing) return; const p=pos(e); const st=getPen(); line(last,p,st); emitDraw(last,p,st); last=p; });
  window.addEventListener('mouseup', ()=>{ drawing=false; last=null; });
}

socket.on('draw', data=>{ if(data.slide===idx){ line({x:data.x0,y:data.y0},{x:data.x1,y:data.y1},{color:data.color,width:data.width}); }});

function clearInk(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

async function exportPDF(){
  const images = [];
  for(let i=0;i<sections.length;i++){
    render(i);
    await new Promise(res=>setTimeout(res, 200));
    const shot = await html2canvas(iframe.contentWindow.document.body);
    const ink = document.createElement('canvas');
    ink.width = shot.width; ink.height = shot.height;
    const ictx = ink.getContext('2d');
    ictx.drawImage(canvas, 0, 0, ink.width, ink.height);

    const merged = document.createElement('canvas');
    merged.width = shot.width; merged.height = shot.height;
    const mctx = merged.getContext('2d');
    mctx.drawImage(shot, 0, 0);
    mctx.drawImage(ink, 0, 0);
    images.push(merged.toDataURL('image/png'));
  }
  const resp = await fetch('/courses/{{ course.id }}/live/export', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({images})});
  const js = await resp.json();
  if(js.ok){ window.open(js.pdf, '_blank'); }
}
</script>
{% endblock %}
